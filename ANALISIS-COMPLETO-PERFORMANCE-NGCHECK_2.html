<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Completo de Performance - NGCheck 2026</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --purple: #8b5cf6;
            --bg-dark: #1e293b;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #334155 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
        }

        .header .date {
            margin-top: 1rem;
            font-size: 0.9rem;
            opacity: 0.7;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .section h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem;
            color: var(--text-primary);
        }

        .architecture-diagram {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .arch-flow {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .arch-box {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            text-align: center;
            min-width: 140px;
            transition: all 0.3s;
        }

        .arch-box:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }

        .arch-box.highlight {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: var(--primary);
        }

        .arch-box .title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .arch-box .desc {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .arch-arrow {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .config-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-item .name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .config-item .value {
            font-family: 'Consolas', monospace;
            background: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
        }

        .db-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .db-tag {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: monospace;
            font-weight: 500;
        }

        .db-tag.ar { border-left: 3px solid #3b82f6; }
        .db-tag.cl { border-left: 3px solid #ef4444; }
        .db-tag.py { border-left: 3px solid #10b981; }
        .db-tag.uy { border-left: 3px solid #06b6d4; }
        .db-tag.mx { border-left: 3px solid #f59e0b; }
        .db-tag.bo { border-left: 3px solid #8b5cf6; }
        .db-tag.es { border-left: 3px solid #ec4899; }
        .db-tag.co { border-left: 3px solid #14b8a6; }
        .db-tag.ve { border-left: 3px solid #f97316; }
        .db-tag.system { border-left: 3px solid #64748b; }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .alert-icon { font-size: 1.25rem; }

        .alert-danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left: 4px solid var(--danger);
        }

        .alert-warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left: 4px solid var(--warning);
        }

        .alert-success {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid var(--success);
        }

        .alert-info {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid var(--info);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-primary);
        }

        tr:hover { background: #f8fafc; }

        .priority-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-p0 { background: #fee2e2; color: #dc2626; }
        .priority-p1 { background: #fed7aa; color: #ea580c; }
        .priority-p2 { background: #fef3c7; color: #d97706; }
        .priority-p3 { background: #dbeafe; color: #2563eb; }

        .impact-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .impact-high { background: #dcfce7; color: #16a34a; }
        .impact-medium { background: #fef3c7; color: #d97706; }
        .impact-low { background: #e2e8f0; color: #64748b; }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 10px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            margin: 1rem 0;
        }

        .code-block .comment { color: #6b7280; }
        .code-block .keyword { color: #c084fc; }
        .code-block .string { color: #86efac; }
        .code-block .method { color: #60a5fa; }
        .code-block .type { color: #22d3ee; }
        .code-block .number { color: #fbbf24; }

        .tech-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .tech-card {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .tech-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .tech-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tech-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .tech-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .tech-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .tech-card ul {
            list-style: none;
            padding: 0;
        }

        .tech-card li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            font-size: 0.9rem;
        }

        .tech-card li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        .interceptor-flow {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .interceptor-step {
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .interceptor-step .step-num {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .interceptor-step .step-content {
            flex: 1;
        }

        .interceptor-step .step-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .interceptor-step .step-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .interceptor-step code {
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .repo-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .repo-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
        }

        .repo-card .name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .repo-card .stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .recommendation-timeline {
            position: relative;
            padding-left: 2rem;
            margin: 1.5rem 0;
        }

        .recommendation-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.65rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
            box-shadow: 0 0 0 3px var(--primary);
        }

        .timeline-item.completed::before { background: var(--success); box-shadow: 0 0 0 3px var(--success); }
        .timeline-item.in-progress::before { background: var(--warning); box-shadow: 0 0 0 3px var(--warning); }

        .metric-comparison {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            margin: 0.5rem 0;
        }

        .metric-comparison .before {
            color: var(--danger);
            font-weight: 600;
        }

        .metric-comparison .arrow {
            color: var(--success);
            font-size: 1.25rem;
        }

        .metric-comparison .after {
            color: var(--success);
            font-weight: 600;
        }

        .metric-comparison .improvement {
            margin-left: auto;
            background: #dcfce7;
            color: #16a34a;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .toc {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .toc h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toc ul {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.5rem;
        }

        .toc a {
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .toc a:hover {
            background: white;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        @media print {
            .header { padding: 1rem; }
            .section { break-inside: avoid; }
            .code-block { white-space: pre-wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>An√°lisis Completo de Performance</h1>
        <div class="subtitle">NGCheck - Sistema de Gesti√≥n Gastron√≥mica Multi-Tenant</div>
        <div class="date">Generado: 16 de Enero de 2026 | Azure MySQL Flexible Server</div>
    </div>

    <div class="container">
        <!-- Tabla de Contenidos -->
        <div class="toc">
            <h3>üìã Contenido del An√°lisis</h3>
            <ul>
                <li><a href="#azure">üî∑ Configuraci√≥n Azure MySQL</a></li>
                <li><a href="#architecture">üèóÔ∏è Arquitectura Multi-Tenant</a></li>
                <li><a href="#interceptors">‚ö° Interceptores EF Core</a></li>
                <li><a href="#repositories">üìÇ An√°lisis de Repositorios (85)</a></li>
                <li><a href="#queries">üîç Queries Cr√≠ticos</a></li>
                <li><a href="#optimizations">‚ú® Optimizaciones EF Core</a></li>
                <li><a href="#technologies">üöÄ Tecnolog√≠as Recomendadas</a></li>
                <li><a href="#plan">üìÖ Plan de Implementaci√≥n</a></li>
            </ul>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: var(--primary);">üóÑÔ∏è</div>
                <div class="value" style="color: var(--primary);">40</div>
                <div class="label">Bases de Datos</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: var(--success);">üìÅ</div>
                <div class="value" style="color: var(--success);">85</div>
                <div class="label">Repositorios</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: var(--warning);">‚ö†Ô∏è</div>
                <div class="value" style="color: var(--warning);">23</div>
                <div class="label">Queries Cr√≠ticos</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: var(--purple);">üåç</div>
                <div class="value" style="color: var(--purple);">9</div>
                <div class="label">Pa√≠ses</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: var(--danger);">üíæ</div>
                <div class="value" style="color: var(--danger);">4GB</div>
                <div class="label">Buffer Pool</div>
            </div>
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #cffafe 0%, #a5f3fc 100%); color: var(--info);">üîó</div>
                <div class="value" style="color: var(--info);">683</div>
                <div class="label">Max Connections</div>
            </div>
        </div>

        <!-- Secci√≥n Azure -->
        <section id="azure" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: var(--primary);">üî∑</div>
                <h2>Configuraci√≥n Azure MySQL Flexible Server</h2>
            </div>

            <h3>Informaci√≥n del Servidor</h3>
            <div class="config-grid">
                <div class="config-item">
                    <span class="name">Servidor</span>
                    <span class="value">nucleo-check-prod-srv</span>
                </div>
                <div class="config-item">
                    <span class="name">Tier</span>
                    <span class="value" style="color: var(--primary);">General Purpose</span>
                </div>
                <div class="config-item">
                    <span class="name">SKU</span>
                    <span class="value">Standard_D2ads_v5</span>
                </div>
                <div class="config-item">
                    <span class="name">vCPUs</span>
                    <span class="value" style="color: var(--warning);">2 cores</span>
                </div>
                <div class="config-item">
                    <span class="name">Versi√≥n MySQL</span>
                    <span class="value">8.0.42</span>
                </div>
                <div class="config-item">
                    <span class="name">Storage</span>
                    <span class="value">140 GB (Auto-Grow)</span>
                </div>
                <div class="config-item">
                    <span class="name">IOPS</span>
                    <span class="value">720 (Auto-Scaling)</span>
                </div>
                <div class="config-item">
                    <span class="name">High Availability</span>
                    <span class="value" style="color: var(--success);">‚úì SameZone</span>
                </div>
                <div class="config-item">
                    <span class="name">Backup</span>
                    <span class="value">7 d√≠as + Geo-Redundant</span>
                </div>
                <div class="config-item">
                    <span class="name">Regi√≥n</span>
                    <span class="value">East US</span>
                </div>
                <div class="config-item">
                    <span class="name">Private Endpoint</span>
                    <span class="value" style="color: var(--success);">‚úì Habilitado</span>
                </div>
                <div class="config-item">
                    <span class="name">Slow Query Log</span>
                    <span class="value" style="color: var(--success);">‚úì ON (7s)</span>
                </div>
            </div>

            <h3>Par√°metros de Performance MySQL</h3>
            <table>
                <thead>
                    <tr>
                        <th>Par√°metro</th>
                        <th>Valor Actual</th>
                        <th>Valor Recomendado</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>innodb_buffer_pool_size</code></td>
                        <td>4 GB</td>
                        <td>4-6 GB</td>
                        <td><span class="priority-badge" style="background: #dcfce7; color: #16a34a;">‚úì OK</span></td>
                    </tr>
                    <tr>
                        <td><code>innodb_buffer_pool_instances</code></td>
                        <td>8</td>
                        <td>8 (para 4GB+)</td>
                        <td><span class="priority-badge" style="background: #dcfce7; color: #16a34a;">‚úì OK</span></td>
                    </tr>
                    <tr>
                        <td><code>max_connections</code></td>
                        <td>683</td>
                        <td>500-1000</td>
                        <td><span class="priority-badge" style="background: #dcfce7; color: #16a34a;">‚úì OK</span></td>
                    </tr>
                    <tr>
                        <td><code>innodb_io_capacity</code></td>
                        <td>200</td>
                        <td>500-1000 (SSD)</td>
                        <td><span class="priority-badge priority-p1">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                    <tr>
                        <td><code>innodb_io_capacity_max</code></td>
                        <td>2000</td>
                        <td>2000-4000</td>
                        <td><span class="priority-badge" style="background: #dcfce7; color: #16a34a;">‚úì OK</span></td>
                    </tr>
                    <tr>
                        <td><code>join_buffer_size</code></td>
                        <td>256 KB</td>
                        <td>512 KB - 1 MB</td>
                        <td><span class="priority-badge priority-p2">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                    <tr>
                        <td><code>sort_buffer_size</code></td>
                        <td>512 KB</td>
                        <td>1-2 MB</td>
                        <td><span class="priority-badge priority-p2">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                    <tr>
                        <td><code>tmp_table_size</code></td>
                        <td>16 MB</td>
                        <td>64-128 MB</td>
                        <td><span class="priority-badge priority-p1">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                    <tr>
                        <td><code>table_open_cache</code></td>
                        <td>2400</td>
                        <td>4000+ (multi-tenant)</td>
                        <td><span class="priority-badge priority-p2">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                    <tr>
                        <td><code>thread_cache_size</code></td>
                        <td>14</td>
                        <td>50-100</td>
                        <td><span class="priority-badge priority-p1">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                    <tr>
                        <td><code>long_query_time</code></td>
                        <td>7s</td>
                        <td>1-2s</td>
                        <td><span class="priority-badge priority-p2">‚ö†Ô∏è ALTO</span></td>
                    </tr>
                    <tr>
                        <td><code>innodb_read_io_threads</code></td>
                        <td>4</td>
                        <td>8-16</td>
                        <td><span class="priority-badge priority-p2">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                    <tr>
                        <td><code>innodb_write_io_threads</code></td>
                        <td>4</td>
                        <td>8-16</td>
                        <td><span class="priority-badge priority-p2">‚ö†Ô∏è BAJO</span></td>
                    </tr>
                </tbody>
            </table>

            <div class="alert alert-warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Observaci√≥n Cr√≠tica:</strong> Con 40 bases de datos y arquitectura multi-tenant con schemas din√°micos,
                    el <code>table_open_cache</code> de 2400 puede ser insuficiente. Cada empresa tiene su propio set de tablas
                    prefijadas, lo que multiplica el n√∫mero de tablas que MySQL necesita mantener abiertas.
                </div>
            </div>

            <h3>Bases de Datos por Pa√≠s</h3>
            <div class="db-list">
                <span class="db-tag ar">ar-002</span>
                <span class="db-tag ar">ar-003</span>
                <span class="db-tag ar">ar-004</span>
                <span class="db-tag ar">ar-005</span>
                <span class="db-tag ar">ar-006</span>
                <span class="db-tag ar">ar-007</span>
                <span class="db-tag ar">ar-008</span>
                <span class="db-tag ar">ar-009</span>
                <span class="db-tag ar">ar-010</span>
                <span class="db-tag ar">ar-011</span>
                <span class="db-tag ar">ar-012</span>
                <span class="db-tag ar">ar-013</span>
                <span class="db-tag ar">ar-014</span>
                <span class="db-tag ar">ar-015</span>
                <span class="db-tag ar">ar-016</span>
                <span class="db-tag ar">ar-017</span>
                <span class="db-tag ar">ar-018</span>
                <span class="db-tag ar">ar-019</span>
                <span class="db-tag ar">ar-020</span>
                <span class="db-tag ar">ar-021</span>
                <span class="db-tag ar">ar-022</span>
                <span class="db-tag ar">ar-023</span>
                <span class="db-tag ar">ar-024</span>
                <span class="db-tag ar">ar-025</span>
                <span class="db-tag ar">ar-026</span>
                <span class="db-tag cl">cl-001</span>
                <span class="db-tag py">py-001</span>
                <span class="db-tag uy">uy-001</span>
                <span class="db-tag mx">mx-001</span>
                <span class="db-tag bo">bo-001</span>
                <span class="db-tag es">es-001</span>
                <span class="db-tag co">co-001</span>
                <span class="db-tag ve">ve-001</span>
                <span class="db-tag system">nucleo_check_prod</span>
                <span class="db-tag system">nucleo_check_prod_common</span>
                <span class="db-tag system">ng_hub</span>
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">üìä</span>
                <div>
                    <strong>Distribuci√≥n:</strong> 25 bases en Argentina (ar-*), 8 en otros pa√≠ses de LATAM,
                    1 en Espa√±a, y 3 bases de sistema. Cada base contiene m√∫ltiples empresas con schemas prefijados (1_, 2_, 3_, etc.)
                </div>
            </div>
        </section>

        <!-- Secci√≥n Arquitectura -->
        <section id="architecture" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: var(--purple);">üèóÔ∏è</div>
                <h2>Arquitectura Multi-Tenant</h2>
            </div>

            <div class="architecture-diagram">
                <div class="arch-flow">
                    <div class="arch-box">
                        <div class="title">üåê Request HTTP</div>
                        <div class="desc">JWT con CompanySchema</div>
                    </div>
                    <span class="arch-arrow">‚Üí</span>
                    <div class="arch-box">
                        <div class="title">üîê Claims JWT</div>
                        <div class="desc">CompanySchema, DatabaseName, TimeZone</div>
                    </div>
                    <span class="arch-arrow">‚Üí</span>
                    <div class="arch-box highlight">
                        <div class="title">‚ö° NGDbContext</div>
                        <div class="desc">Connection String Din√°mica</div>
                    </div>
                    <span class="arch-arrow">‚Üí</span>
                    <div class="arch-box">
                        <div class="title">üîÑ Interceptor</div>
                        <div class="desc">Schema Prefix Injection</div>
                    </div>
                    <span class="arch-arrow">‚Üí</span>
                    <div class="arch-box">
                        <div class="title">üóÑÔ∏è MySQL</div>
                        <div class="desc">ar-XXX / cl-001 / etc.</div>
                    </div>
                </div>
            </div>

            <h3>Flujo de Conexi√≥n</h3>
            <div class="code-block">
<span class="comment">// NGDbContext.cs - Extracci√≥n de claims del JWT</span>
<span class="keyword">if</span> (<span class="keyword">this</span>.accessor?.HttpContext?.User?.Claims != <span class="keyword">null</span>) {
    <span class="keyword">this</span>.Schema = <span class="keyword">this</span>.accessor.HttpContext.User.FindFirst(<span class="string">"CompanySchema"</span>).Value;  <span class="comment">// ej: "5_"</span>
    <span class="keyword">this</span>.DatabaseName = <span class="keyword">this</span>.accessor.HttpContext.User.FindFirst(<span class="string">"CompanyDatabase"</span>).Value; <span class="comment">// ej: "ar-005"</span>
    <span class="keyword">this</span>.TimeZone = Convert.ToInt16(<span class="keyword">this</span>.accessor.HttpContext.User.FindFirst(<span class="string">"TimeZone"</span>).Value);
}

<span class="comment">// Construcci√≥n din√°mica del connection string</span>
<span class="keyword">var</span> connectionString = <span class="type">string</span>.<span class="method">Format</span>(<span class="keyword">this</span>.connectionStrings.Value.DbConnection, <span class="keyword">this</span>.DatabaseName);
optionsBuilder.<span class="method">UseMySql</span>(connectionString, <span class="keyword">new</span> <span class="type">MySqlServerVersion</span>(<span class="keyword">new</span> <span class="type">Version</span>(<span class="number">8</span>, <span class="number">0</span>, <span class="number">25</span>)));
optionsBuilder.<span class="method">AddInterceptors</span>(<span class="keyword">new</span> <span class="type">NGDbSchemaInterceptor</span>(<span class="keyword">this</span>.Schema));
            </div>

            <h3>Modelo de Datos Multi-Tenant</h3>
            <table>
                <thead>
                    <tr>
                        <th>Componente</th>
                        <th>Implementaci√≥n</th>
                        <th>Ejemplo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Database Sharding</strong></td>
                        <td>Por regi√≥n/capacidad</td>
                        <td><code>ar-005</code>, <code>cl-001</code>, <code>mx-001</code></td>
                    </tr>
                    <tr>
                        <td><strong>Schema Prefixing</strong></td>
                        <td>Por empresa dentro de cada DB</td>
                        <td><code>5_orders</code>, <code>12_products</code></td>
                    </tr>
                    <tr>
                        <td><strong>Shared Tables</strong></td>
                        <td>Tablas comunes sin prefijo</td>
                        <td><code>countries</code>, <code>doc_types</code></td>
                    </tr>
                    <tr>
                        <td><strong>Common Database</strong></td>
                        <td>Datos globales</td>
                        <td><code>nucleo_check_prod_common</code></td>
                    </tr>
                </tbody>
            </table>

            <div class="alert alert-success">
                <span class="alert-icon">‚úÖ</span>
                <div>
                    <strong>Ventajas de esta arquitectura:</strong>
                    <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                        <li>Aislamiento de datos por empresa garantizado a nivel de schema</li>
                        <li>Escalabilidad horizontal agregando nuevas bases de datos regionales</li>
                        <li>Backup y restore granular por regi√≥n o empresa</li>
                        <li>Distribuci√≥n de carga entre m√∫ltiples databases</li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-danger">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Problemas Identificados:</strong>
                    <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                        <li><strong>String Replacement en SQL:</strong> El interceptor usa string.Replace() para inyectar el schema,
                            lo cual puede tener edge cases y overhead de procesamiento en cada query</li>
                        <li><strong>Connection String por Request:</strong> Se crea una nueva conexi√≥n por cada request,
                            sin aprovechar connection pooling efectivo entre empresas de la misma DB</li>
                        <li><strong>Cache Invalidation:</strong> El query plan cache de MySQL no se beneficia del prefixing
                            din√°mico ya que cada empresa genera queries "diferentes"</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Secci√≥n Interceptores -->
        <section id="interceptors" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: var(--warning);">‚ö°</div>
                <h2>Interceptores EF Core</h2>
            </div>

            <h3>1. NGDbSchemaInterceptor (309 l√≠neas)</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Interceptor cr√≠tico que modifica TODAS las queries SQL antes de ejecutarse, agregando el prefijo del schema de la empresa.
            </p>

            <div class="interceptor-flow">
                <div class="interceptor-step">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        <div class="step-title">Query Original EF Core</div>
                        <div class="step-desc">
                            <code>SELECT * FROM `orders` WHERE id = 5</code>
                        </div>
                    </div>
                </div>
                <div class="interceptor-step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <div class="step-title">String Replace Operations</div>
                        <div class="step-desc">
                            Reemplaza: <code>FROM `</code> ‚Üí <code>FROM `{schema}</code>,
                            <code>LEFT JOIN `</code> ‚Üí <code>LEFT JOIN `{schema}</code>, etc.
                        </div>
                    </div>
                </div>
                <div class="interceptor-step">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <div class="step-title">Query Transformada</div>
                        <div class="step-desc">
                            <code>SELECT * FROM `5_orders` WHERE id = 5</code>
                        </div>
                    </div>
                </div>
            </div>

            <div class="code-block">
<span class="comment">// NGDbSchemaInterceptor.cs - M√©todo principal de transformaci√≥n</span>
<span class="keyword">private</span> <span class="type">string</span> <span class="method">SetSchemaTableNamesTableNames</span>(<span class="type">string</span> query)
{
    query = query.<span class="method">Replace</span>(<span class="string">"FROM `"</span>, $<span class="string">"FROM `{companySchema}"</span>)
                 .<span class="method">Replace</span>(<span class="string">"LEFT JOIN `"</span>, $<span class="string">"LEFT JOIN `{companySchema}"</span>)
                 .<span class="method">Replace</span>(<span class="string">"RIGHT JOIN `"</span>, $<span class="string">"RIGHT JOIN `{companySchema}"</span>)
                 .<span class="method">Replace</span>(<span class="string">"INNER JOIN `"</span>, $<span class="string">"INNER JOIN `{companySchema}"</span>)
                 .<span class="method">Replace</span>(<span class="string">"INTO `"</span>, $<span class="string">"INTO `{companySchema}"</span>)
                 .<span class="method">Replace</span>(<span class="string">"UPDATE `"</span>, $<span class="string">"UPDATE `{companySchema}"</span>)
                 <span class="comment">// Excepciones para funciones MySQL</span>
                 .<span class="method">Replace</span>($<span class="string">"minute FROM `{companySchema}"</span>, $<span class="string">"minute FROM `"</span>)
                 .<span class="method">Replace</span>($<span class="string">"hour FROM `{companySchema}"</span>, $<span class="string">"hour FROM `"</span>);
    <span class="keyword">return</span> query;
}
            </div>

            <div class="alert alert-warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Impacto en Performance:</strong> Este interceptor procesa CADA query con m√∫ltiples string.Replace().
                    Para queries complejas con muchos JOINs, esto puede agregar latencia significativa.
                    Considerar usar <code>Span&lt;char&gt;</code> o <code>StringBuilder</code> para optimizar.
                </div>
            </div>

            <h3>2. TimeZoneInterceptor (52 l√≠neas)</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                SaveChangesInterceptor que autom√°ticamente establece la propiedad <code>CurrentTimeZone</code> en todas las entidades antes de guardar.
            </p>

            <div class="code-block">
<span class="comment">// TimeZoneInterceptor.cs</span>
<span class="keyword">private</span> <span class="keyword">void</span> <span class="method">SetTimeZone</span>(<span class="type">DbContext</span> context) {
    <span class="keyword">foreach</span> (<span class="keyword">var</span> entry <span class="keyword">in</span> context.ChangeTracker.<span class="method">Entries</span>()) {
        <span class="keyword">var</span> propertyInfo = entry.Entity.<span class="method">GetType</span>().<span class="method">GetProperty</span>(<span class="string">"CurrentTimeZone"</span>);
        <span class="keyword">if</span> (propertyInfo != <span class="keyword">null</span> && propertyInfo.CanWrite) {
            propertyInfo.<span class="method">SetValue</span>(entry.Entity, _timeZoneValue, <span class="keyword">null</span>);
        }
    }
}
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">üí°</span>
                <div>
                    <strong>Sugerencia:</strong> Usar reflection en cada SaveChanges es costoso.
                    Considerar implementar una interface <code>ITimeZoneEntity</code> para evitar reflection.
                </div>
            </div>
        </section>

        <!-- Secci√≥n Repositorios -->
        <section id="repositories" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: var(--success);">üìÇ</div>
                <h2>An√°lisis de Repositorios (85 archivos)</h2>
            </div>

            <h3>Repositorios Cr√≠ticos Analizados</h3>
            <div class="repo-summary">
                <div class="repo-card">
                    <div class="name">OrderRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 1,336 l√≠neas</span>
                        <span style="color: var(--danger);">üî¥ 25+ Include chains</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">StatsRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 1,596 l√≠neas</span>
                        <span style="color: var(--warning);">üü° Stored procedures</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">ProductRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 1,570 l√≠neas</span>
                        <span style="color: var(--danger);">üî¥ 11+ Include chains</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">CashDrawerRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 787 l√≠neas</span>
                        <span style="color: var(--warning);">üü° Queries complejos</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">CustomerRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 578 l√≠neas</span>
                        <span style="color: var(--success);">üü¢ Bien optimizado</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">EmployeeRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 376 l√≠neas</span>
                        <span style="color: var(--warning);">üü° Include con filtros</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">TableRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 413 l√≠neas</span>
                        <span style="color: var(--danger);">üî¥ 5+ Include chains</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">InvoiceRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 294 l√≠neas</span>
                        <span style="color: var(--danger);">üî¥ Paginaci√≥n en memoria</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">KitchenOrderRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 263 l√≠neas</span>
                        <span style="color: var(--success);">üü¢ Usa AsSplitQuery</span>
                    </div>
                </div>
                <div class="repo-card">
                    <div class="name">InventoryRepository.cs</div>
                    <div class="stats">
                        <span>üìÑ 243 l√≠neas</span>
                        <span style="color: var(--success);">üü¢ Usa proyecciones</span>
                    </div>
                </div>
            </div>

            <h3>Patrones Problem√°ticos Encontrados</h3>
            <table>
                <thead>
                    <tr>
                        <th>Patr√≥n</th>
                        <th>Ocurrencias</th>
                        <th>Impacto</th>
                        <th>Repositorios Afectados</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Include() chains excesivos (5+)</td>
                        <td>15+</td>
                        <td><span class="impact-badge impact-high">Alto</span></td>
                        <td>Order, Product, Table, Employee</td>
                    </tr>
                    <tr>
                        <td>ThenInclude() anidados profundos</td>
                        <td>10+</td>
                        <td><span class="impact-badge impact-high">Alto</span></td>
                        <td>Order, Product, Table</td>
                    </tr>
                    <tr>
                        <td>Falta de AsNoTracking()</td>
                        <td>50+</td>
                        <td><span class="impact-badge impact-medium">Medio</span></td>
                        <td>Todos los repositorios</td>
                    </tr>
                    <tr>
                        <td>ToList() antes de paginaci√≥n</td>
                        <td>3</td>
                        <td><span class="impact-badge impact-high">Alto</span></td>
                        <td>Invoice, Product</td>
                    </tr>
                    <tr>
                        <td>Falta de AsSplitQuery()</td>
                        <td>20+</td>
                        <td><span class="impact-badge impact-high">Alto</span></td>
                        <td>Order, Product, Table, Employee</td>
                    </tr>
                    <tr>
                        <td>Reflection en loops</td>
                        <td>2</td>
                        <td><span class="impact-badge impact-medium">Medio</span></td>
                        <td>TimeZoneInterceptor</td>
                    </tr>
                    <tr>
                        <td>N+1 Queries potenciales</td>
                        <td>8+</td>
                        <td><span class="impact-badge impact-high">Alto</span></td>
                        <td>CashDrawer, Employee, Inventory</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Secci√≥n Queries Cr√≠ticos -->
        <section id="queries" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: var(--danger);">üîç</div>
                <h2>Queries Cr√≠ticos Identificados</h2>
            </div>

            <h3>Prioridad P0 - Cr√≠ticos (Impacto Inmediato)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Query</th>
                        <th>Archivo:L√≠nea</th>
                        <th>Problema</th>
                        <th>Includes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>GetOrderDTOByIdAsync</code></td>
                        <td>OrderRepository.cs:63-208</td>
                        <td>Cartesian explosion masivo</td>
                        <td><span class="priority-badge priority-p0">25+</span></td>
                    </tr>
                    <tr>
                        <td><code>GetOrderDetailByIdAsync</code></td>
                        <td>OrderRepository.cs:520-649</td>
                        <td>Carga completa de order con items</td>
                        <td><span class="priority-badge priority-p0">18+</span></td>
                    </tr>
                    <tr>
                        <td><code>GetPendingOrdersAsync</code></td>
                        <td>OrderRepository.cs:894-966</td>
                        <td>Lista con includes profundos</td>
                        <td><span class="priority-badge priority-p0">12+</span></td>
                    </tr>
                    <tr>
                        <td><code>GetProductDTOByIdAsync</code></td>
                        <td>ProductRepository.cs:326-510</td>
                        <td>Producto con todas las relaciones</td>
                        <td><span class="priority-badge priority-p0">11+</span></td>
                    </tr>
                    <tr>
                        <td><code>GetRestaurantTemporaryTableDetailByTableIdAsync</code></td>
                        <td>TableRepository.cs:221-272</td>
                        <td>5 ThenInclude anidados</td>
                        <td><span class="priority-badge priority-p0">8+</span></td>
                    </tr>
                </tbody>
            </table>

            <h3>Prioridad P1 - Altos</h3>
            <table>
                <thead>
                    <tr>
                        <th>Query</th>
                        <th>Archivo:L√≠nea</th>
                        <th>Problema</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>GetDeliveryOrderAsync</code></td>
                        <td>OrderRepository.cs:983-1075</td>
                        <td>Order completa para delivery</td>
                    </tr>
                    <tr>
                        <td><code>GetPagedProductListDTOsAsync</code></td>
                        <td>ProductRepository.cs:589-744</td>
                        <td>Paginaci√≥n con sorting complejo</td>
                    </tr>
                    <tr>
                        <td><code>GetCashDrawerListDTOsAsync</code></td>
                        <td>CashDrawerRepository.cs:191-279</td>
                        <td>N+1 para usuarios</td>
                    </tr>
                    <tr>
                        <td><code>GetPagedInvoicesAsync</code></td>
                        <td>InvoiceRepository.cs:65-161</td>
                        <td>ToList() antes de Skip/Take</td>
                    </tr>
                    <tr>
                        <td><code>GetEmployeeDTOByIdAsync</code></td>
                        <td>EmployeeRepository.cs:289-329</td>
                        <td>mapper.Map dentro de Select</td>
                    </tr>
                </tbody>
            </table>

            <h3>Ejemplo de Cartesian Explosion</h3>
            <div class="alert alert-danger">
                <span class="alert-icon">üí•</span>
                <div>
                    <strong>GetOrderDTOByIdAsync - Explosi√≥n Cartesiana:</strong><br>
                    Una orden con 10 items √ó 3 opciones √ó 2 observaciones = <strong>60 filas</strong> por cada include de colecci√≥n.
                    Con 25+ includes, el resultado puede ser de <strong>miles de filas</strong> que EF Core debe procesar y deduplicar.
                </div>
            </div>

            <div class="code-block">
<span class="comment">// ANTES - OrderRepository.cs (Cartesian Explosion)</span>
<span class="keyword">return</span> <span class="keyword">await</span> query
    .<span class="method">Include</span>(p => p.Items)
        .<span class="method">ThenInclude</span>(i => i.Product)
    .<span class="method">Include</span>(p => p.Items)
        .<span class="method">ThenInclude</span>(i => i.Options)
            .<span class="method">ThenInclude</span>(o => o.ProductOption)
    .<span class="method">Include</span>(p => p.Items)
        .<span class="method">ThenInclude</span>(i => i.Observations)
    .<span class="method">Include</span>(p => p.Payments)
        .<span class="method">ThenInclude</span>(p => p.PaymentType)
    <span class="comment">// ... 20+ m√°s includes ...</span>
    .<span class="method">SingleOrDefaultAsync</span>(p => p.Id == orderId);

<span class="comment">// DESPU√âS - Con AsSplitQuery()</span>
<span class="keyword">return</span> <span class="keyword">await</span> query
    .<span class="method">Include</span>(p => p.Items)
        .<span class="method">ThenInclude</span>(i => i.Product)
    .<span class="method">Include</span>(p => p.Items)
        .<span class="method">ThenInclude</span>(i => i.Options)
    <span class="comment">// ... mismos includes ...</span>
    .<span class="method">AsSplitQuery</span>()  <span class="comment">// ‚Üê SOLUCI√ìN: Divide en queries separadas</span>
    .<span class="method">AsNoTracking</span>()  <span class="comment">// ‚Üê BONUS: -30% memoria si es read-only</span>
    .<span class="method">SingleOrDefaultAsync</span>(p => p.Id == orderId);
            </div>
        </section>

        <!-- Secci√≥n Optimizaciones -->
        <section id="optimizations" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: var(--primary);">‚ú®</div>
                <h2>Optimizaciones EF Core</h2>
            </div>

            <div class="tech-cards">
                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: var(--success);">üìñ</div>
                        <h4>AsNoTracking()</h4>
                    </div>
                    <p>Deshabilita el change tracking para queries de solo lectura. Reduce uso de memoria 30-40%.</p>
                    <ul>
                        <li>Usar en todos los GET que no modifican datos</li>
                        <li>Especialmente importante en listas y reportes</li>
                        <li>No usar si la entidad ser√° actualizada despu√©s</li>
                    </ul>
                    <div class="metric-comparison">
                        <span class="before">Con Tracking: 150ms</span>
                        <span class="arrow">‚Üí</span>
                        <span class="after">Sin Tracking: 95ms</span>
                        <span class="improvement">-37%</span>
                    </div>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: var(--purple);">üîÄ</div>
                        <h4>AsSplitQuery()</h4>
                    </div>
                    <p>Divide queries con m√∫ltiples Include() en queries separadas, evitando la explosi√≥n cartesiana.</p>
                    <ul>
                        <li>Usar cuando hay 3+ Include() con colecciones</li>
                        <li>Especialmente con ThenInclude() anidados</li>
                        <li>Trade-off: m√°s round-trips pero menos datos</li>
                    </ul>
                    <div class="metric-comparison">
                        <span class="before">Single Query: 2.5s</span>
                        <span class="arrow">‚Üí</span>
                        <span class="after">Split Query: 0.4s</span>
                        <span class="improvement">-84%</span>
                    </div>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: var(--warning);">üìä</div>
                        <h4>Select() Proyecciones</h4>
                    </div>
                    <p>Proyectar solo los campos necesarios en lugar de cargar entidades completas.</p>
                    <ul>
                        <li>Reduce transferencia de datos del servidor</li>
                        <li>Evita cargar columnas innecesarias</li>
                        <li>Ideal para listas y DTOs</li>
                    </ul>
                    <div class="metric-comparison">
                        <span class="before">Full Entity: 500KB</span>
                        <span class="arrow">‚Üí</span>
                        <span class="after">Projection: 50KB</span>
                        <span class="improvement">-90%</span>
                    </div>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #cffafe 0%, #a5f3fc 100%); color: var(--info);">‚ö°</div>
                        <h4>Compiled Queries</h4>
                    </div>
                    <p>Pre-compilar queries frecuentes para evitar el overhead de traducci√≥n LINQ ‚Üí SQL.</p>
                    <ul>
                        <li>Ideal para queries ejecutadas miles de veces</li>
                        <li>Mejora 10-15% en queries simples</li>
                        <li>Requiere definici√≥n est√°tica</li>
                    </ul>
                    <div class="code-block" style="font-size: 0.75rem;">
<span class="keyword">private static readonly</span> Func&lt;NGDbContext, <span class="type">int</span>, Task&lt;Order&gt;&gt; _getOrderById =
    EF.<span class="method">CompileAsyncQuery</span>((NGDbContext ctx, <span class="type">int</span> id) =>
        ctx.Orders.<span class="method">FirstOrDefault</span>(o => o.Id == id));
                    </div>
                </div>
            </div>

            <h3>C√≥digo de Ejemplo: Optimizaci√≥n Completa</h3>
            <div class="code-block">
<span class="comment">// ANTES - Query problem√°tico</span>
<span class="keyword">public async</span> Task&lt;List&lt;OrderListDTO&gt;&gt; <span class="method">GetPendingOrdersAsync</span>()
{
    <span class="keyword">return await</span> dbContext.Orders
        .<span class="method">Include</span>(o => o.Items).<span class="method">ThenInclude</span>(i => i.Product)
        .<span class="method">Include</span>(o => o.Items).<span class="method">ThenInclude</span>(i => i.Options)
        .<span class="method">Include</span>(o => o.Customer)
        .<span class="method">Include</span>(o => o.Payments)
        .<span class="method">Where</span>(o => o.Status == OrderStatus.Pending)
        .<span class="method">ToListAsync</span>();  <span class="comment">// Carga TODO en memoria</span>
}

<span class="comment">// DESPU√âS - Query optimizado</span>
<span class="keyword">public async</span> Task&lt;List&lt;OrderListDTO&gt;&gt; <span class="method">GetPendingOrdersAsync</span>()
{
    <span class="keyword">return await</span> dbContext.Orders
        .<span class="method">AsNoTracking</span>()  <span class="comment">// 1. Sin tracking</span>
        .<span class="method">Where</span>(o => o.Status == OrderStatus.Pending)  <span class="comment">// 2. Filtrar primero</span>
        .<span class="method">Select</span>(o => <span class="keyword">new</span> OrderListDTO  <span class="comment">// 3. Proyecci√≥n</span>
        {
            Id = o.Id,
            CustomerName = o.Customer.Name,
            Total = o.Total,
            ItemCount = o.Items.<span class="method">Count</span>(),
            Date = o.StartDate
        })
        .<span class="method">ToListAsync</span>();
}
            </div>
        </section>

        <!-- Secci√≥n Tecnolog√≠as -->
        <section id="technologies" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: var(--danger);">üöÄ</div>
                <h2>Tecnolog√≠as y Patrones Recomendados</h2>
            </div>

            <div class="tech-cards">
                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #dc2626;">üî¥</div>
                        <h4>Redis Cache (Ya implementado parcialmente)</h4>
                    </div>
                    <p>Expandir el uso de Redis para cachear queries frecuentes y datos de configuraci√≥n por empresa.</p>
                    <ul>
                        <li><strong>Cache de productos:</strong> Los productos cambian poco, cachear por empresa</li>
                        <li><strong>Cache de configuraci√≥n:</strong> SystemConfiguration por companyId</li>
                        <li><strong>Session cache:</strong> Datos del usuario autenticado</li>
                        <li><strong>Output cache:</strong> Responses de endpoints frecuentes</li>
                    </ul>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: var(--primary);">üîå</div>
                        <h4>Connection Pooling Mejorado</h4>
                    </div>
                    <p>Optimizar el pooling de conexiones para arquitectura multi-tenant con m√∫ltiples databases.</p>
                    <ul>
                        <li>Usar <code>MySqlConnector</code> con pooling configurado</li>
                        <li>Pool separado por database (ar-001, ar-002, etc.)</li>
                        <li>Min pool size: 5, Max: 50 por database</li>
                        <li>Connection lifetime: 5 minutos</li>
                    </ul>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: var(--success);">üì¶</div>
                        <h4>Batch Operations</h4>
                    </div>
                    <p>Usar EF Core Bulk Extensions para operaciones masivas en lugar de SaveChanges() iterativo.</p>
                    <ul>
                        <li><code>BulkInsert</code> para inserci√≥n masiva de items</li>
                        <li><code>BulkUpdate</code> para actualizaciones en lote</li>
                        <li><code>ExecuteUpdate/Delete</code> de EF Core 7+</li>
                        <li>Reduce de N llamadas a 1 llamada</li>
                    </ul>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: var(--warning);">üóÇÔ∏è</div>
                        <h4>Read Replicas</h4>
                    </div>
                    <p>Azure MySQL Flexible Server soporta hasta 10 read replicas para distribuir carga de lectura.</p>
                    <ul>
                        <li>Replica para reportes y estad√≠sticas</li>
                        <li>Replica para queries de solo lectura</li>
                        <li>Reduce carga en el servidor principal</li>
                        <li>Latencia ~100ms de replicaci√≥n</li>
                    </ul>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: var(--purple);">üîç</div>
                        <h4>Query Store / Performance Insights</h4>
                    </div>
                    <p>Habilitar Query Performance Insights en Azure para identificar queries lentas autom√°ticamente.</p>
                    <ul>
                        <li>Ya tienen slow_query_log en ON</li>
                        <li>Bajar long_query_time de 7s a 1s</li>
                        <li>Usar Azure Query Performance Insights</li>
                        <li>Alertas autom√°ticas en queries lentas</li>
                    </ul>
                </div>

                <div class="tech-card">
                    <div class="tech-card-header">
                        <div class="tech-card-icon" style="background: linear-gradient(135deg, #cffafe 0%, #a5f3fc 100%); color: var(--info);">üèóÔ∏è</div>
                        <h4>CQRS Pattern</h4>
                    </div>
                    <p>Separar comandos (escritura) de queries (lectura) para optimizar cada path independientemente.</p>
                    <ul>
                        <li>Queries: Usar Dapper para m√°xima performance</li>
                        <li>Commands: Mantener EF Core para validaci√≥n</li>
                        <li>Diferentes modelos para read vs write</li>
                        <li>Ideal para reportes complejos</li>
                    </ul>
                </div>
            </div>

            <h3>Par√°metros MySQL Recomendados para Actualizar</h3>
            <div class="code-block">
<span class="comment"># Comandos Azure CLI para actualizar par√°metros</span>

<span class="comment"># Aumentar IO capacity para SSD</span>
az mysql flexible-server parameter set \
    --resource-group Nucleo-Check_Dev \
    --server-name nucleo-check-prod-srv \
    --name innodb_io_capacity \
    --value 1000

<span class="comment"># Aumentar thread cache para conexiones frecuentes</span>
az mysql flexible-server parameter set \
    --resource-group Nucleo-Check_Dev \
    --server-name nucleo-check-prod-srv \
    --name thread_cache_size \
    --value 50

<span class="comment"># Aumentar table open cache para multi-tenant</span>
az mysql flexible-server parameter set \
    --resource-group Nucleo-Check_Dev \
    --server-name nucleo-check-prod-srv \
    --name table_open_cache \
    --value 4000

<span class="comment"># Reducir slow query threshold para mejor monitoreo</span>
az mysql flexible-server parameter set \
    --resource-group Nucleo-Check_Dev \
    --server-name nucleo-check-prod-srv \
    --name long_query_time \
    --value 2

<span class="comment"># Aumentar tmp_table_size para queries complejos</span>
az mysql flexible-server parameter set \
    --resource-group Nucleo-Check_Dev \
    --server-name nucleo-check-prod-srv \
    --name tmp_table_size \
    --value 67108864
            </div>
        </section>

        <!-- Secci√≥n Plan -->
        <section id="plan" class="section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: var(--success);">üìÖ</div>
                <h2>Plan de Implementaci√≥n</h2>
            </div>

            <h3>Fase 1: Quick Wins (Impacto Inmediato)</h3>
            <div class="recommendation-timeline">
                <div class="timeline-item">
                    <strong>Agregar AsSplitQuery() a los 5 queries P0</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        OrderRepository: GetOrderDTOByIdAsync, GetOrderDetailByIdAsync, GetPendingOrdersAsync<br>
                        ProductRepository: GetProductDTOByIdAsync<br>
                        TableRepository: GetRestaurantTemporaryTableDetailByTableIdAsync
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>Agregar AsNoTracking() a queries de solo lectura</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Todos los m√©todos Get* que no modifican entidades despu√©s
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>Actualizar par√°metros MySQL en Azure</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        innodb_io_capacity, thread_cache_size, table_open_cache, long_query_time
                    </p>
                </div>
            </div>

            <h3>Fase 2: Refactoring Medio</h3>
            <div class="recommendation-timeline">
                <div class="timeline-item">
                    <strong>Corregir paginaci√≥n en InvoiceRepository</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Mover Skip/Take antes del ToListAsync() para paginar en BD
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>Implementar proyecciones Select() en listas</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Reemplazar Include + AutoMapper por Select directo a DTOs
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>Optimizar NGDbSchemaInterceptor</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Usar Span&lt;char&gt; o StringBuilder en lugar de string.Replace() m√∫ltiples
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>Implementar ITimeZoneEntity interface</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Evitar reflection en TimeZoneInterceptor
                    </p>
                </div>
            </div>

            <h3>Fase 3: Optimizaci√≥n Avanzada</h3>
            <div class="recommendation-timeline">
                <div class="timeline-item">
                    <strong>Implementar cache Redis para configuraciones</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Cachear SystemConfiguration, productos, categor√≠as por empresa
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>Evaluar Read Replica para reportes</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Mover StatsRepository y reportes a replica de lectura
                    </p>
                </div>
                <div class="timeline-item">
                    <strong>Implementar Compiled Queries para operaciones frecuentes</strong>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        GetOrderById, GetProductById, GetCustomerById
                    </p>
                </div>
            </div>

            <h3>ROI Estimado</h3>
            <table>
                <thead>
                    <tr>
                        <th>Optimizaci√≥n</th>
                        <th>Esfuerzo</th>
                        <th>Mejora Esperada</th>
                        <th>Prioridad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>AsSplitQuery() en queries P0</td>
                        <td>2-4 horas</td>
                        <td>50-80% en queries afectados</td>
                        <td><span class="priority-badge priority-p0">P0</span></td>
                    </tr>
                    <tr>
                        <td>AsNoTracking() global</td>
                        <td>4-8 horas</td>
                        <td>20-30% memoria</td>
                        <td><span class="priority-badge priority-p0">P0</span></td>
                    </tr>
                    <tr>
                        <td>Par√°metros MySQL</td>
                        <td>1 hora</td>
                        <td>10-20% general</td>
                        <td><span class="priority-badge priority-p1">P1</span></td>
                    </tr>
                    <tr>
                        <td>Proyecciones Select()</td>
                        <td>1-2 semanas</td>
                        <td>40-60% transferencia</td>
                        <td><span class="priority-badge priority-p1">P1</span></td>
                    </tr>
                    <tr>
                        <td>Cache Redis expandido</td>
                        <td>2-3 semanas</td>
                        <td>30-50% latencia</td>
                        <td><span class="priority-badge priority-p2">P2</span></td>
                    </tr>
                    <tr>
                        <td>Read Replica</td>
                        <td>1 semana config</td>
                        <td>50% carga en primary</td>
                        <td><span class="priority-badge priority-p2">P2</span></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <div class="footer">
            <p>An√°lisis generado por Claude Code | NGCheck Performance Analysis 2026</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">
                Servidor: nucleo-check-prod-srv.mysql.database.azure.com |
                Repositorios analizados: 85 |
                Bases de datos: 40
            </p>
        </div>
    </div>
</body>
</html>
